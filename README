T-D04 - Pipeline DevOps

Dos microservicios "conversion-service" (Node 18 / PHP-FPM 8.2) con Git Flow, Conventional Commits, CI/CD en GitHub Actions, publicaciÃ³n en Docker Hub y despliegue por Docker Compose.

ğŸ“‚ Estructura del proyecto

conversion-service/
â”œâ”€â”€ node-converter/
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â””â”€â”€ app.js
â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”œâ”€â”€ uploads/           # ficheros subidos
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ package-lock.json
â”‚   â””â”€â”€ Dockerfile
â”‚   â””â”€â”€ __tests__/
â”‚       â””â”€â”€ app.test.js    # Jest + Supertest
â”‚
â”œâ”€â”€ php-converter/
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ app.php
â”‚   â”‚   â””â”€â”€ index.php
â”‚   â”œâ”€â”€ converted/         # ficheros convertidos
â”‚   â”œâ”€â”€ tests/
â”‚   â”‚   â””â”€â”€ ConvertTest.php
â”‚   â”œâ”€â”€ composer.json
â”‚   â”œâ”€â”€ composer.lock
â”‚   â”œâ”€â”€ phpunit.xml
â”‚   â””â”€â”€ Dockerfile
â”‚
â””â”€â”€ docker-compose.yml

âš™ï¸ Prerrequisitos

Docker & Docker Compose

Node 18

PHP 8.2 & Composer

Git

(Opcional) act para probar GitHub Actions en local

ğŸš€ Desarrollo local

Copiar .env.example a .env y ajustar variables si es necesario.

Levantar ambos servicios:

docker-compose up --build -d

Verificar contenedores:

docker-compose ps

ğŸ”§ Endpoints

Node-converter (puerto 4000)

GET /health

{ "status": "ok", "timestamp": "2025-05-20T..." }

POST /convert (multipart/form-data)

Campos:

archivo (fichero real)

formato (ej. pdf, txt)

Respuesta HTTP 202:

{ "status": "pendiente", "id": "uuid-tarea" }

GET /convert/:idEstado de la tarea (pendiente/completado + resultUrl).

PHP-converter (puerto 4001)

GET /health

{ "status": "ok", "timestamp": "2025-05-20T..." }

POST /convert (JSON)

{
  "id": "uuid-tarea",
  "input": {
    "filePath": "/uploads/tmp1234",
    "originalName": "doc.docx",
    "formato": "pdf"
  }
}

Respuesta HTTP 200:

{
  "status": "completado",
  "id": "uuid-tarea",
  "resultUrl": "/converted/uuid-tarea.pdf"
}

GET /converted/{file}Descarga el fichero convertido.

ğŸ§ª Tests

Node

cd conversion-service/node-converter
npm install
npm test

PHP

cd conversion-service/php-converter
composer install
composer test

ğŸ“‹ GitHub Actions

Badges (aÃ±ade al README):

![CI](https://github.com/tu-orga/tu-repo/actions/workflows/ci.yml/badge.svg)

Lint commits: Conventional Commits

Build & Test & Scan: Docker Buildx + Jest/PHPUnit + Trivy + SBOM

Push: sobre tags vX.Y.Z

Deploy: en main, con docker-compose pull && up -d

ğŸš¢ PublicaciÃ³n y despliegue

Crear tag semÃ¡ntico y push:

git tag v1.0.0
git push origin v1.0.0

GitHub Actions:

build-test-scan â†’ seguridad â†’ push imÃ¡genes a Docker Hub

deploy (en main) en tu runner self-hosted:

cd /ruta/al/proyecto
docker-compose pull
docker-compose up -d

ğŸ”’ Seguridad

Secrets en GitHub: REGISTRY_URL, REGISTRY_USERNAME, REGISTRY_PASSWORD

SBOM generado (spdx-json)

Trivy muestra vulnerabilidades (exit-code 0, solo informa)

ğŸ“– MÃ¡s informaciÃ³n

Conventional Commits

GitHub Actions

Docker Compose

Trivy

Anchore SBOM Action

Nota: Ajusta rutas y valores segÃºn tu entorno.